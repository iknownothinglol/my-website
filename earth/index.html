<!DOCTYPE html>
<html>
<head>
  <title>可交互的地球</title>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="planetary.js"></script>
  <style>
    body { margin: 0; }
    #globe { 
      width: 100%; 
      height: 100vh; 
      display: block; 
    }
  </style>
</head>
<body>
  <canvas id="globe"></canvas>
  <script>
    var canvas = document.getElementById('globe');
    var globe = planetaryjs.planet(); 
    globe.projection.rotate([100, -10, 0]);
    globe.draw(canvas);

    globe.loadPlugin(planetaryjs.plugins.earth({
      topojson: { file:   'world-110m.json' },
      oceans:   { fill:   '#001320' },
      land:     { fill:   '#06304e' },
      borders:  { stroke: '#001320' }
    }));

    globe.loadPlugin(planetaryjs.plugins.pings());
    globe.loadPlugin(planetaryjs.plugins.drag({
      onDragStart: function() {
        this.plugins.autorotate.pause();
      },
      onDragEnd: function() {
        this.plugins.autorotate.resume();
      }
    }));

    globe.loadPlugin(autorotate(10)); 

    function autorotate(degPerSec) {
      return function(planet) {
        var lastTick = null;
        var paused = false;
        planet.plugins.autorotate = {
          pause:  function() { paused = true;  },
          resume: function() { paused = false; }
        };
        planet.onDraw(function() {
          if (paused || !lastTick) {
            lastTick = new Date();
          } else {
            var now = new Date();
            var delta = now - lastTick;
            var rotation = planet.projection.rotate();
            rotation[0] += degPerSec * delta / 1000;
            if (rotation[0] >= 180) rotation[0] -= 360;
            planet.projection.rotate(rotation);
            lastTick = now;
          }
        });
      };
    };

    setInterval(function() {
      var lat = Math.random() * 170 - 85;
      var lng = Math.random() * 360 - 180;
      var color = '#' + Math.floor(Math.random() * 16777215).toString(16);
      globe.plugins.pings.add(lng, lat, { color: color, ttl: 2000, angle: Math.random() * 10 });
    }, 150);
  </script>
</body>
</html>
